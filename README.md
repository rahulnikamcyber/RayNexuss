# Lead-Vendor Automation Platform

A complete production-ready platform for automating lead distribution to vendors with WhatsApp notifications, payment integration, and comprehensive dashboards.

## Features

- ✅ Customer Lead Submission Form
- ✅ Vendor Registration & Management
- ✅ Automated Lead Routing (City + Service matching)
- ✅ WhatsApp Notifications
- ✅ Credit-Based System
- ✅ Payment Integration (Razorpay/Stripe)
- ✅ Admin Dashboard with Analytics
- ✅ Vendor Dashboard
- ✅ Duplicate Lead Detection
- ✅ JWT Authentication
- ✅ PostgreSQL Database

## Tech Stack

**Backend:**
- Python 3.11
- FastAPI
- SQLAlchemy
- PostgreSQL
- JWT Authentication
- Gunicorn + Uvicorn

**Frontend:**
- HTML5
- Tailwind CSS
- Chart.js
- Jinja2 Templates

**Integrations:**
- WhatsApp API (Twilio/UltraMsg/Meta)
- Email (SMTP)
- Razorpay/Stripe Payments

## Project Structure

```
lead-vendor-platform/
├── main.py                 # FastAPI application
├── requirements.txt        # Python dependencies
├── render.yaml            # Render configuration
├── .env.example           # Environment variables template
├── README.md              # This file
└── templates/             # HTML templates
    ├── base.html
    ├── index.html
    ├── lead_form.html
    ├── vendor_register.html
    ├── login.html
    ├── lead_success.html
    ├── vendor_success.html
    ├── admin_dashboard.html
    └── vendor_dashboard.html
```

## Deployment on Render

### Step 1: Create GitHub Repository

1. Create a new repository on GitHub
2. Clone it locally:
```bash
git clone https://github.com/YOUR_USERNAME/lead-vendor-platform.git
cd lead-vendor-platform
```

3. Copy all project files to the repository
4. Create templates folder and add all HTML files
5. Commit and push:
```bash
git add .
git commit -m "Initial commit: Lead-Vendor Platform"
git push origin main
```

### Step 2: Deploy on Render

1. Go to [render.com](https://render.com) and sign up/login
2. Click **"New +"** → **"Blueprint"**
3. Connect your GitHub repository
4. Render will detect `render.yaml` and create:
   - Web Service (Python app)
   - PostgreSQL Database

5. Click **"Apply"** to start deployment

### Step 3: Configure Environment Variables

After deployment, go to your web service dashboard and add:

**Required Variables:**
```
DATABASE_URL          # Auto-generated by Render
SECRET_KEY           # Auto-generated by Render
```

**WhatsApp Integration (Optional but Recommended):**
```
WHATSAPP_API_URL     # Your WhatsApp API endpoint
WHATSAPP_API_TOKEN   # Your WhatsApp API token
```

**Email Configuration (Optional):**
```
SMTP_HOST            # Default: smtp.gmail.com
SMTP_PORT            # Default: 587
SMTP_USER            # Your email
SMTP_PASSWORD        # Your email app password
```

**Payment Gateway (Optional):**
```
RAZORPAY_KEY_ID      # Your Razorpay Key ID
RAZORPAY_KEY_SECRET  # Your Razorpay Secret
```

### Step 4: Access Your Application

Your app will be live at: `https://lead-vendor-platform.onrender.com`

## Default Admin Credentials

```
Username: admin
Password: admin123
```

**⚠️ IMPORTANT: Change these credentials immediately after first login!**

## Routes & Pages

### Public Routes
- `/` - Home page
- `/lead-form` - Customer lead submission
- `/vendor-register` - Vendor registration
- `/login` - Login page

### Protected Routes
- `/admin/dashboard` - Admin dashboard (admin only)
- `/vendor/dashboard` - Vendor dashboard (vendors only)
- `/logout` - Logout

## Lead ID Generation

**System Lead ID Format:**
```
LD-{SERVICE}-{CITY}-{DDYYYYMM}-{SEQ}
Example: LD-SOLAR-SURAT-27202512-004
```

**Vendor ID Format:**
```
VD-{SERVICE}-{CITY}-{SEQ}
Example: VD-SOLAR-SURAT-001
```

**Vendor Lead Numbers:**
- Each vendor sees: Lead #001, #002, #003...
- System maintains internal mapping
- Vendors cannot see total platform leads

## Lead Routing Logic

1. Customer submits lead
2. System checks for duplicates (Name + Mobile)
3. If not duplicate:
   - Generate unique System Lead ID
   - Match vendors by City + Service Type
   - Filter only ACTIVE vendors with credits > 0
   - Send lead to all matching vendors
   - Deduct 1 credit per vendor
   - Send WhatsApp notification
   - Fallback to email if WhatsApp fails

## Credit System

- Vendors start with 0 credits (INACTIVE)
- Purchase credits via payment gateway
- Each lead costs 1 credit
- When credits = 0, vendor becomes INACTIVE
- Auto-activate after payment

## WhatsApp Integration Options

### Option 1: Twilio (Recommended)
```python
WHATSAPP_API_URL=https://api.twilio.com/2010-04-01/Accounts/{ACCOUNT_SID}/Messages.json
WHATSAPP_API_TOKEN=your_auth_token
```

### Option 2: UltraMsg
```python
WHATSAPP_API_URL=https://api.ultramsg.com/{instance_id}/messages/chat
WHATSAPP_API_TOKEN=your_token
```

### Option 3: Meta Business API
```python
WHATSAPP_API_URL=https://graph.facebook.com/v18.0/{PHONE_NUMBER_ID}/messages
WHATSAPP_API_TOKEN=your_access_token
```

## Payment Webhook

For Razorpay webhook handler, add this route to `main.py`:

```python
@app.post("/webhook/razorpay")
async def razorpay_webhook(request: Request, db: Session = Depends(get_db)):
    payload = await request.json()
    # Verify signature
    # Update vendor credits
    # Activate vendor
    # Send invoice
    return {"status": "success"}
```

Configure webhook URL in Razorpay Dashboard:
```
https://your-app.onrender.com/webhook/razorpay
```

## Database Schema

**Tables:**
- `vendors` - Vendor information and credits
- `leads` - Customer leads
- `lead_assignments` - Lead-to-Vendor mapping
- `payments` - Payment transactions
- `admins` - Admin users

## Development

To run locally (optional):

```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables
export DATABASE_URL=sqlite:///./leads.db
export SECRET_KEY=dev-secret-key

# Run server
uvicorn main:app --reload --port 8000
```

Visit: `http://localhost:8000`

## Security Features

- ✅ Password hashing with bcrypt
- ✅ JWT token authentication
- ✅ HTTP-only cookies
- ✅ CSRF protection ready
- ✅ SQL injection prevention (SQLAlchemy ORM)
- ✅ Environment-based configuration

## Monitoring & Logs

View logs in Render Dashboard:
1. Go to your web service
2. Click "Logs" tab
3. Monitor real-time application logs

## Troubleshooting

### Database Connection Issues
```bash
# Check DATABASE_URL format
# Should be: postgresql://user:pass@host:port/db
```

### WhatsApp Not Sending
```bash
# Check WHATSAPP_API_URL and WHATSAPP_API_TOKEN
# Test API endpoint manually
# Check logs for error messages
```

### Payment Webhook Not Working
```bash
# Verify webhook URL in payment gateway dashboard
# Check webhook signature validation
# Enable webhook logs
```

## Support

For issues or questions:
1. Check Render logs
2. Review environment variables
3. Verify database connection
4. Test API integrations individually

## License

MIT License - Feel free to modify and use for your projects.

---

**Built with ❤️ using FastAPI and deployed on Render**
